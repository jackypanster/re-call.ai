# re-call.ai 技术架构设计文档

## 🧠 系统概述

re-call.ai 是一个基于AI的个人记忆管理系统，通过集成mem0等成熟的AI记忆服务，为用户提供智能的记录、搜索和记忆管理功能。

### 核心设计理念
- **AI服务优先**：使用成熟的AI记忆服务(mem0)替代自建
- **简单可靠**：避免过度工程，专注用户体验
- **快速迭代**：支持敏捷开发和快速功能验证
- **成本可控**：合理使用SaaS服务，控制运营成本

## 📐 系统架构图

```text
┌─────────────────────────────┐
│      前端界面 (Web/Mobile)    │ ◄──── 用户记录/搜索交互
└─────────────────────────────┘
                │
                ▼
┌─────────────────────────────┐
│       API网关 (FastAPI)      │ ◄──── REST接口、认证、路由
└─────────────────────────────┘
                │
      ┌─────────┼──────────┐
      ▼                     ▼
┌───────────────┐   ┌────────────────┐
│   记忆服务层    │   │    业务逻辑层    │
│   (mem0 API)   │   │  (分类/标签/用户) │
└───────────────┘   └────────────────┘
      │                     │
      ▼                     ▼
┌─────────────────────────────┐
│        数据持久层           │
│   (PostgreSQL + Redis)     │
└─────────────────────────────┘
```

## 🎯 核心技术栈

### 记忆管理核心
- **mem0 Platform**：主要的AI记忆服务
  - 智能记忆提取和存储
  - 语义搜索和检索  
  - 用户/代理记忆分离
  - 高级过滤和元数据管理

### 应用框架
- **后端**：FastAPI (Python 3.11+)
- **前端**：Next.js + React + TypeScript
- **数据库**：PostgreSQL (用户数据、会话管理)
- **缓存**：Redis (会话、API缓存)
- **部署**：Docker + 云原生平台

## 🔧 服务集成架构

| 层级 | 组件 | 技术选型 | 用途 |
|------|------|----------|------|
| **前端层** | Web界面 | Next.js + TailwindCSS | 用户交互界面 |
| **API层** | 接口服务 | FastAPI + Pydantic | REST API、数据验证 |
| **记忆层** | AI记忆 | mem0 Platform API | 核心记忆管理 |
| **业务层** | 逻辑处理 | Python服务 | 用户管理、权限控制 |
| **数据层** | 持久化 | PostgreSQL + Redis | 元数据存储、缓存 |
| **部署层** | 基础设施 | Docker + 云平台 | 容器化部署 |

## 📊 数据流设计

### 记录流程
```text
[1] 用户输入文本/语音 →
[2] FastAPI接收处理 →
[3] 调用mem0 API存储 →
[4] 返回记忆ID和状态 →
[5] 更新用户记录统计
```

### 搜索流程  
```text
[1] 用户输入查询 →
[2] 构建搜索参数 →
[3] 调用mem0搜索API →
[4] 应用业务过滤器 →
[5] 返回格式化结果
```

## 🔌 外部服务依赖

| 服务 | 提供商 | 用途 | 成本模式 |
|------|--------|------|----------|
| **AI记忆** | mem0.ai | 核心记忆管理 | 按API调用计费 |
| **语音转文本** | OpenAI Whisper API | 语音记录支持 | 按使用量计费 |
| **用户认证** | Auth0 / Supabase | 用户身份管理 | 免费额度+付费 |
| **文件存储** | Supabase Storage | 附件文件存储 | 按存储量计费 |
| **部署平台** | Railway / Vercel | 应用部署托管 | 免费额度+付费 |

## 🛠️ 开发环境配置

### 环境变量管理
```bash
# mem0配置
MEM0_API_KEY=m0-xxx
MEM0_BASE_URL=https://api.mem0.ai

# 数据库配置  
DATABASE_URL=postgresql://user:pass@host:port/db
REDIS_URL=redis://host:port

# 认证配置
JWT_SECRET_KEY=xxx
AUTH0_DOMAIN=xxx

# 外部服务
OPENAI_API_KEY=xxx (语音转文本)
SUPABASE_URL=xxx
SUPABASE_KEY=xxx
```

### 开发工具链
- **依赖管理**：uv (Python包管理)
- **代码质量**：ruff (代码检查)、black (格式化)
- **测试框架**：pytest + httpx
- **API文档**：FastAPI自动生成Swagger
- **前端工具**：npm/yarn + ESLint + Prettier

## 🚀 部署策略

### 开发环境
- **本地开发**：Docker Compose + 本地PostgreSQL
- **测试环境**：GitHub Actions CI/CD
- **预览环境**：Vercel Preview Deploy

### 生产环境
- **API服务**：Railway / Render (容器部署)
- **前端**：Vercel (静态部署+Serverless)
- **数据库**：Supabase / Railway PostgreSQL
- **监控**：应用日志 + 健康检查

## 🔒 安全与隐私

### 数据安全
- **传输加密**：全站HTTPS，API调用SSL
- **存储加密**：敏感数据字段级加密
- **访问控制**：JWT认证 + RBAC权限模型

### 隐私保护
- **数据分离**：用户记忆严格隔离
- **API密钥**：环境变量安全存储
- **审计日志**：关键操作日志记录

## 📈 性能优化

### 缓存策略
- **Redis缓存**：热点查询结果缓存
- **CDN缓存**：静态资源全球分发
- **API缓存**：mem0查询结果短期缓存

### 扩展性设计
- **水平扩展**：API服务无状态设计
- **异步处理**：长时间操作异步队列
- **限流保护**：API调用频率限制

## 🧪 测试策略

### 自动化测试
- **单元测试**：核心业务逻辑测试
- **集成测试**：mem0 API集成测试
- **端到端测试**：关键用户流程测试

### 质量保证
- **代码覆盖率**：目标85%+
- **性能测试**：API响应时间监控
- **安全测试**：依赖漏洞扫描

## 🔄 技术演进规划

### 短期优化 (1-3个月)
- [ ] 优化mem0 API调用效率
- [ ] 实现用户记忆分类管理
- [ ] 添加语音输入支持

### 中期扩展 (3-6个月)  
- [ ] 移动端应用开发
- [ ] 多模态记录支持
- [ ] 智能记忆推荐

### 长期规划 (6-12个月)
- [ ] 本地部署选项
- [ ] 企业级功能
- [ ] 开放API平台

---

**文档更新记录**
- 2024年12月：基于mem0平台重构架构设计
- 移除supermemory相关组件，采用mem0作为核心记忆服务
- 简化技术栈，专注核心功能实现
